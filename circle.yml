general:
  build_dir: tests

dependencies:
  pre:
    - sudo pip install paramiko PyYAML jinja2 httplib2
    - sudo pip install ansible

machine:
  environment:
    PLAYBOOK: playbook.yml
  hosts:
    myapp.com: 127.0.0.1

test:
  pre:
    - sudo ln -s ansible-role-mysql ../../mauricios.MySQL
  override:
    - ansible-playbook $PLAYBOOK --syntax-check
    - ansible-playbook $PLAYBOOK --connection=local
    - "ansible-playbook $PLAYBOOK --connection=local | grep -q 'changed=0.*failed=0' && (echo 'Idempotence test: pass' && exit 0) || (echo 'Idempotence test: fail' && exit 1)"
    - mysql -V
    - apachectl -v
    - php -v
    - php -i | grep -q 'mysql' && (echo 'PHP MySQL installed' && exit 0) || (echo 'PHP MySQL not installed' && exit 1)
    - apachectl -M | grep -q 'php' && (echo 'PHP module for Apache installed' && exit 0) || (echo 'HP module for Apache not installed' && exit 1)
    - curl http://myapp.com
